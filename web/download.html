<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Models - ALICE</title>
    <link rel="stylesheet" href="/web/fonts/inter.css">
    <link rel="stylesheet" href="/web/style.css">
    <style>
        .search-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .search-section .form-group {
            flex: 1;
            max-width: 400px;
            margin-bottom: 0;
        }
        
        .search-section .btn {
            align-self: flex-end;
            height: 44px;
        }
        
        .source-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            justify-content: center;
        }
        
        .source-tab {
            padding: 0.6rem 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .source-tab:hover {
            border-color: var(--border-light);
            color: var(--text-primary);
        }
        
        .source-tab.active {
            background: var(--accent-glow);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .model-grid .empty-state {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }
        
        .model-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .model-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .model-card .preview {
            aspect-ratio: 16/10;
            background: var(--bg-elevated);
            overflow: hidden;
            position: relative;
        }
        
        .model-card .preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .model-card .preview .no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }
        
        .model-card .info {
            padding: 1rem;
        }
        
        .model-card .name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .model-card .creator {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .model-card .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        
        .model-card .stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .model-card .type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--info-bg);
            color: var(--info);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }
        
        .model-card .type-badge.lora {
            background: var(--warning-bg);
            color: var(--warning);
        }
        
        .download-queue {
            margin-top: 1.5rem;
        }
        
        .download-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }
        
        .download-item .info {
            flex: 1;
            min-width: 0;
        }
        
        .download-item .name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .download-item .progress-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .download-item .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .download-item .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }
        
        .download-item .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: right;
        }
        
        .download-item .status-badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }
        
        .download-item .status-badge.downloading {
            background: var(--info-bg);
            color: var(--info);
        }
        
        .download-item .status-badge.completed {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .download-item .status-badge.failed {
            background: var(--error-bg);
            color: var(--error);
        }
        
        .download-item .status-badge.queued {
            background: var(--warning-bg);
            color: var(--warning);
        }
        
        @media (max-width: 768px) {
            .search-section {
                flex-direction: column;
            }
            
            .source-tabs {
                flex-wrap: wrap;
            }
            
            .model-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-brand">
            <a href="/web/" class="logo"><img src="/web/alice-logo.png" alt="ALICE" style="height: 40px; width: auto; display: inline-block; margin-right: 8px; vertical-align: middle;"><span style="display: inline-block; vertical-align: middle; font-weight: 700; font-size: 1.2rem; color: var(--accent);">ALICE</span></a>
        </div>
        <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('open')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <div class="nav-links">
            <a href="/web/" class="admin-only">Dashboard</a>
            <a href="/web/models.html" class="admin-only">Models</a>
            <a href="/web/generate.html">Generate</a>
            <a href="/web/gallery.html">Gallery</a>
            <a href="/web/prompting.html">Prompting Guide</a>
            <a href="/web/download.html" class="active admin-only">Download</a>
            <a href="/web/admin.html" class="admin-only">Admin</a>
            <a href="/docs" target="_blank">API Docs</a>
            <a href="/web/login.html" class="login-link">Login</a>
            <a href="#" onclick="window.SDAPI.logout(); return false;" class="logout-link">Logout</a>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </nav>
    
    <main>
        <div class="page-header">
            <h1>Download Models</h1>
            <p>Search and download models from CivitAI and HuggingFace</p>
        </div>
        
        <!-- API Key Notice -->
        <div class="card" style="border-color: var(--warning); background: var(--warning-bg); margin-bottom: 1rem;">
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--warning)" style="flex-shrink: 0;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <strong style="color: var(--warning);">CivitAI API Key Required</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">
                        To download models from CivitAI, you need to set your API key in the config file at <code>~/.config/alice/config.yaml</code>.
                        Get your API key from <a href="https://civitai.com/user/account" target="_blank" style="color: var(--accent);">civitai.com/user/account</a> â†’ API Keys.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Source Tabs -->
        <div class="source-tabs">
            <button class="source-tab active" data-source="civitai">CivitAI</button>
            <button class="source-tab" data-source="huggingface">HuggingFace</button>
        </div>
        
        <!-- Search Section -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search Models
                </span>
                <button class="btn btn-secondary" id="sync-catalog-btn" style="margin-left: auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Sync Catalog
                </button>
            </div>
            
            <div class="search-section">
                <div class="form-group">
                    <input type="text" id="search-query" placeholder="Search for models..." autocomplete="off">
                </div>
                <div class="form-group" id="type-filter-group">
                    <select id="type-filter">
                        <option value="">All Types</option>
                        <option value="Checkpoint">Checkpoints</option>
                        <option value="LORA">LoRAs</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="search-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search
                </button>
            </div>
            
            <!-- Search Results -->
            <div id="search-results" class="model-grid">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <p class="title">Search for models</p>
                    <p>Enter a search term to find models from CivitAI or HuggingFace</p>
                </div>
            </div>
        </div>
        
        <!-- Download Queue -->
        <div class="card download-queue">
            <div class="card-header">
                <span class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download Queue
                </span>
                <button class="btn btn-secondary btn-sm" id="refresh-queue-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
            </div>
            
            <div id="download-queue-list">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <p class="title">No active downloads</p>
                    <p>Search and select models to download</p>
                </div>
            </div>
        </div>
    </main>
    
    <script src="/web/app.js"></script>
    <script>
        // Initialize theme immediately (before DOMContentLoaded to prevent flash)
        if (typeof initTheme === 'function') initTheme();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.SDAPI === 'undefined') {
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--error);">Error: ALICE JavaScript failed to load. Please refresh the page.</div>';
                return;
            }
            
            const { API, Toast, requireAuth } = window.SDAPI;
            
            // Check authentication - download page is admin-only
            const authResult = await requireAuth({ adminOnly: true });
            
            // Add admin class to body for CSS to show admin links
            if (authResult.isAdmin) {
                document.body.classList.add('is-admin');
            }
            
            let currentSource = 'civitai';
            let allModels = [];  // Full list for local filtering
            let searchResults = [];  // Filtered/displayed results
            let downloadQueueInterval = null;
            
            // Source tab switching
            document.querySelectorAll('.source-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentSource = tab.dataset.source;
                    
                    // Show/hide type filter for CivitAI
                    document.getElementById('type-filter-group').style.display = 
                        currentSource === 'civitai' ? 'block' : 'none';
                    
                    // Clear results and load browse mode for CivitAI
                    searchResults = [];
                    renderSearchResults();
                    
                    // Auto-load popular checkpoints for CivitAI
                    if (currentSource === 'civitai') {
                        loadPopularModels();
                    }
                });
            });
            
            // Load popular models (browse mode - no query)
            async function loadPopularModels() {
                // Guard: Only proceed if still on CivitAI tab
                if (currentSource !== 'civitai') return;
                
                const btn = document.getElementById('search-btn');
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 18px; height: 18px; border-width: 2px;"></div> Loading...';
                
                try {
                    // Fetch multiple pages to get a good variety
                    allModels = [];
                    const pagesToFetch = 3;  // Fetch 3 pages for better variety
                    const typeFilter = document.getElementById('type-filter').value;
                    
                    for (let page = 1; page <= pagesToFetch; page++) {
                        const response = await API.fetch('/v1/models/search/civitai', {
                            method: 'POST',
                            body: JSON.stringify({
                                query: "",  // Empty = browse mode
                                types: typeFilter ? [typeFilter] : [],  // Send type filter to API
                                limit: 100,
                                page: page
                            })
                        });
                        
                        // Guard: User may have switched tabs during async fetch
                        if (currentSource !== 'civitai') {
                            return;
                        }
                        
                        if (response.data && response.data.length > 0) {
                            // Add models, avoiding duplicates by ID
                            for (const model of response.data) {
                                if (!allModels.some(m => m.id === model.id)) {
                                    allModels.push(model);
                                }
                            }
                        } else {
                            break;  // No more results
                        }
                    }
                    
                    // No need for local filtering anymore - API does it
                    searchResults = allModels;
                    renderSearchResults();
                    
                    if (allModels.length > 0) {
                        Toast.success(`Loaded ${allModels.length} popular models`);
                    }
                } catch (error) {
                    // Only show error if still on CivitAI tab
                    if (currentSource === 'civitai') {
                        Toast.error(`Failed to load models: ${error.message}`);
                    }
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg> Search`;
                }
            }
            
            // Search function - filters locally for CivitAI, API call for HuggingFace
            async function performSearch() {
                const query = document.getElementById('search-query').value.trim().toLowerCase();
                
                // CivitAI: filter loaded models locally
                if (currentSource === 'civitai') {
                    const typeFilter = document.getElementById('type-filter').value;
                    let filtered = allModels;
                    
                    // Apply type filter first
                    if (typeFilter) {
                        filtered = filtered.filter(m => m.type === typeFilter);
                    }
                    
                    if (!query) {
                        // No query = show all (type-)filtered models
                        searchResults = filtered;
                    } else {
                        // Filter locally by name
                        searchResults = filtered.filter(m => 
                            m.name.toLowerCase().includes(query) ||
                            (m.creator && m.creator.toLowerCase().includes(query)) ||
                            (m.tags && m.tags.some(t => t.toLowerCase().includes(query)))
                        );
                    }
                    renderSearchResults();
                    
                    if (query && searchResults.length === 0) {
                        Toast.info('No matching models - try browsing or use a different search');
                    } else if (query) {
                        Toast.success(`Found ${searchResults.length} matching models`);
                    }
                    return;
                }
                
                // HuggingFace: API search
                if (!query) {
                    Toast.warning('Please enter a search term');
                    return;
                }
                
                const btn = document.getElementById('search-btn');
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 18px; height: 18px; border-width: 2px;"></div> Searching...';
                
                try {
                    const response = await API.fetch('/v1/models/search/huggingface', {
                        method: 'POST',
                        body: JSON.stringify({
                            query: query,
                            limit: 1000  // Fetch more results for better search
                        })
                    });
                    
                    // Guard: User may have switched tabs during async fetch
                    if (currentSource !== 'huggingface') {
                        return;
                    }
                    
                    searchResults = response.data || [];
                    renderSearchResults();
                    
                    if (searchResults.length === 0) {
                        Toast.info('No models found');
                    } else {
                        Toast.success(`Found ${searchResults.length} models`);
                    }
                    
                } catch (error) {
                    // Only show error if still on HuggingFace tab
                    if (currentSource === 'huggingface') {
                        Toast.error(`Search failed: ${error.message}`);
                    }
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg> Search`;
                }
            }
            
            // Render search results
            function renderSearchResults() {
                const container = document.getElementById('search-results');
                
                if (searchResults.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <p class="title">Search for models</p>
                            <p>Enter a search term to find models from CivitAI or HuggingFace</p>
                        </div>
                    `;
                    return;
                }
                
                if (currentSource === 'civitai') {
                    container.innerHTML = searchResults.map(model => `
                        <div class="model-card" data-model-id="${model.id}">
                            <div class="preview">
                                ${model.images && model.images[0] 
                                    ? `<img src="${model.images[0]}" alt="${model.name}" loading="lazy">`
                                    : `<div class="no-image"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>`
                                }
                            </div>
                            <div class="info">
                                <div class="name" title="${model.name}">${model.name}</div>
                                <div class="creator">by ${model.creator}</div>
                                <div class="type-badge ${model.type.toLowerCase()}">${model.type}</div>
                                <div class="stats">
                                    <span title="Downloads">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        ${formatNumber(model.download_count)}
                                    </span>
                                    <span title="Rating">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                        </svg>
                                        ${model.rating.toFixed(1)}
                                    </span>
                                </div>
                                <button class="btn btn-primary btn-sm btn-block download-btn" data-model='${JSON.stringify({
                                    id: model.id,
                                    name: model.name,
                                    type: model.type,
                                    versions: model.versions
                                })}'>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = searchResults.map(model => `
                        <div class="model-card" data-model-id="${model.id}">
                            <div class="preview">
                                <div class="no-image">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                </div>
                            </div>
                            <div class="info">
                                <div class="name" title="${model.id}">${model.id.split('/').pop()}</div>
                                <div class="creator">by ${model.author}</div>
                                ${model.pipeline_tag ? `<div class="type-badge">${model.pipeline_tag}</div>` : ''}
                                <div class="stats">
                                    <span title="Downloads">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        ${formatNumber(model.downloads)}
                                    </span>
                                    <span title="Likes">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                        </svg>
                                        ${formatNumber(model.likes)}
                                    </span>
                                </div>
                                <button class="btn btn-primary btn-sm btn-block download-btn" data-model='${JSON.stringify({
                                    id: model.id
                                })}'>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Add click handlers for download buttons
                container.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const modelData = JSON.parse(btn.dataset.model);
                        await downloadModel(modelData);
                    });
                });
            }
            
            // Download model
            async function downloadModel(modelData) {
                try {
                    let response;
                    
                    if (currentSource === 'civitai') {
                        response = await API.fetch('/v1/models/download/civitai', {
                            method: 'POST',
                            body: JSON.stringify({
                                modelId: modelData.id,
                                modelType: modelData.type
                            })
                        });
                    } else {
                        response = await API.fetch('/v1/models/download/huggingface', {
                            method: 'POST',
                            body: JSON.stringify({
                                modelId: modelData.id
                            })
                        });
                    }
                    
                    Toast.success(`Download started: ${modelData.name || modelData.id}`);
                    refreshDownloadQueue();
                    
                } catch (error) {
                    Toast.error(`Download failed: ${error.message}`);
                }
            }
            
            // Refresh download queue
            async function refreshDownloadQueue() {
                try {
                    const response = await API.fetch('/v1/models/download/status');
                    renderDownloadQueue(response.data || []);
                } catch (error) {
                    console.error('Failed to refresh download queue:', error);
                }
            }
            
            // Render download queue
            function renderDownloadQueue(tasks) {
                const container = document.getElementById('download-queue-list');
                
                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            <p class="title">No active downloads</p>
                            <p>Search and select models to download</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="download-item" data-task-id="${task.id}">
                        <div class="info">
                            <div class="name">${task.name}</div>
                            <div class="progress-row">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${task.progress}%"></div>
                                </div>
                                <div class="progress-text">${task.progress.toFixed(1)}%</div>
                            </div>
                            ${task.speed > 0 ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${formatBytes(task.speed)}/s</div>` : ''}
                            ${task.error ? `<div style="font-size: 0.75rem; color: var(--error); margin-top: 0.25rem;">${task.error}</div>` : ''}
                        </div>
                        <span class="status-badge ${task.status}">${task.status}</span>
                        ${task.status === 'downloading' || task.status === 'queued' ? `
                            <button class="btn btn-ghost cancel-btn" data-task-id="${task.id}" title="Cancel">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                `).join('');
                
                // Add cancel handlers
                container.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const taskId = btn.dataset.taskId;
                        try {
                            await API.fetch(`/v1/models/download/${taskId}`, { method: 'DELETE' });
                            Toast.success('Download cancelled');
                            refreshDownloadQueue();
                        } catch (error) {
                            Toast.error(`Cancel failed: ${error.message}`);
                        }
                    });
                });
            }
            
            // Format number
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }
            
            // Format bytes
            function formatBytes(bytes) {
                if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + ' GB';
                if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
                if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return bytes + ' B';
            }
            
            // Event listeners
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('search-query').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('sync-catalog-btn').addEventListener('click', async () => {
                const btn = document.getElementById('sync-catalog-btn');
                const originalHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Syncing...';
                
                try {
                    const adminKey = localStorage.getItem('alice-admin-key');
                    if (!adminKey) {
                        Toast.error('Admin key required. Please log in as admin.');
                        return;
                    }
                    
                    const response = await API.fetch('/v1/admin/cache/sync', {
                        method: 'POST',
                        headers: { 'X-Admin-Key': adminKey }
                    });
                    
                    Toast.success('Catalog sync started! This may take 30-45 minutes. Models will appear as they are cached.');
                    
                    // Reload current view after a short delay
                    setTimeout(() => {
                        if (currentSource === 'civitai' && !document.getElementById('search-query').value.trim()) {
                            loadPopularModels();
                        }
                    }, 3000);
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    Toast.error(`Failed to start sync: ${error.message || 'Unknown error'}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            });
            document.getElementById('refresh-queue-btn').addEventListener('click', refreshDownloadQueue);
            document.getElementById('type-filter').addEventListener('change', () => {
                // Reload when type filter changes
                if (currentSource === 'civitai' && !document.getElementById('search-query').value.trim()) {
                    loadPopularModels();
                }
            });
            
            // Start polling for download queue updates
            refreshDownloadQueue();
            downloadQueueInterval = setInterval(refreshDownloadQueue, 3000);
            
            // Load popular checkpoints on initial page load
            loadPopularModels();
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (downloadQueueInterval) clearInterval(downloadQueueInterval);
            });
        });
    </script>
</body>
</html>
