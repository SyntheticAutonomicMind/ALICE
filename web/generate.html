<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate - ALICE</title>
    <link rel="stylesheet" href="/web/fonts/inter.css">
    <link rel="stylesheet" href="/web/style.css">
    <style>
        .gen-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1024px) {
            .gen-container {
                grid-template-columns: 1fr;
            }
            
            .preview-area {
                position: static !important;
            }
        }
        
        /* Privacy toggle */
        .privacy-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        #privacy-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Orientation toggle button - inline with size presets */
        #orientation-toggle:disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-brand">
            <a href="/web/" class="logo">ALICE</a>
        </div>
        <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('open')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <div class="nav-links">
            <a href="/web/" class="admin-only">Dashboard</a>
            <a href="/web/models.html" class="admin-only">Models</a>
            <a href="/web/generate.html" class="active">Generate</a>
            <a href="/web/gallery.html">Gallery</a>
            <a href="/web/prompting.html">Prompting Guide</a>
            <a href="/web/download.html" class="admin-only">Download</a>
            <a href="/web/admin.html" class="admin-only">Admin</a>
            <a href="/docs" target="_blank">API Docs</a>
            <a href="/web/login.html" class="login-link">Login</a>
            <a href="#" onclick="window.SDAPI.logout(); return false;" class="logout-link">Logout</a>
        </div>
    </nav>
    
    <main>
        <div class="page-header">
            <h1>Generate Image</h1>
            <p>Create stunning images with Stable Diffusion</p>
        </div>
        
        <div class="gen-container">
            <!-- Generation Form -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                            </svg>
                            Generation Settings
                        </span>
                    </div>
                    
                    <form id="gen-form" class="gen-form">
                        <!-- Model Selection -->
                        <div class="form-group">
                            <label for="model">Model</label>
                            <select id="model" required>
                                <option value="" disabled selected>Loading models...</option>
                            </select>
                        </div>
                        
                        <!-- Prompt -->
                        <div class="form-group">
                            <label for="prompt">Prompt</label>
                            <textarea id="prompt" rows="4" placeholder="A serene mountain landscape at sunset, detailed, photorealistic, 8k" required></textarea>
                        </div>
                        
                        <!-- Negative Prompt -->
                        <div class="form-group">
                            <label for="negative-prompt">Negative Prompt</label>
                            <textarea id="negative-prompt" rows="2" placeholder="blurry, low quality, distorted, ugly"></textarea>
                        </div>
                        
                        <!-- LoRA Section (will be populated dynamically) -->
                        <div class="form-group" id="lora-section" style="display: none;">
                            <label>LoRA Models</label>
                            <div id="lora-list" class="lora-list"></div>
                        </div>
                        
                        <!-- Size Presets -->
                        <div class="form-group">
                            <label>Size (auto-rounded to multiples of 8)</label>
                            <div class="size-presets">
                                <button type="button" id="orientation-toggle" class="size-preset" title="Switch between landscape and portrait" style="display: flex; align-items: center; gap: 0.4rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span id="orientation-label">Landscape</span>
                                </button>
                                <!-- SD 1.5 presets -->
                                <button type="button" class="size-preset" data-width="512" data-height="512" title="SD 1.5 Square (1:1)">512</button>
                                <button type="button" class="size-preset" data-width="768" data-height="512" title="SD 1.5 Landscape (3:2)">768×512</button>
                                <button type="button" class="size-preset" data-width="768" data-height="768" title="SD 1.5 Large Square (1:1)">768</button>
                                <!-- SDXL Portrait -->
                                <button type="button" class="size-preset" data-width="832" data-height="1248" title="SDXL Portrait (2:3)">832×1248</button>
                                <button type="button" class="size-preset" data-width="880" data-height="1176" title="SDXL Standard Portrait (3:4)">880×1176</button>
                                <button type="button" class="size-preset" data-width="912" data-height="1144" title="SDXL Large Format (4:5)">912×1144</button>
                                <!-- SDXL Square -->
                                <button type="button" class="size-preset" data-width="1024" data-height="1024" title="SDXL Square (1:1)">1024</button>
                                <!-- SDXL Landscape -->
                                <button type="button" class="size-preset" data-width="1176" data-height="880" title="SDXL SD TV (4:3)">1176×880</button>
                                <button type="button" class="size-preset" data-width="1224" data-height="856" title="SDXL IMAX (1.43:1)">1224×856</button>
                                <button type="button" class="size-preset" data-width="1296" data-height="800" title="SDXL Golden Ratio (1.618:1)">1296×800</button>
                                <button type="button" class="size-preset" data-width="1312" data-height="792" title="SDXL European Wide (1.66:1)">1312×792</button>
                                <!-- SDXL Widescreen -->
                                <button type="button" class="size-preset" data-width="1360" data-height="768" title="SDXL Widescreen HD (16:9)">1360×768</button>
                                <button type="button" class="size-preset" data-width="1392" data-height="752" title="SDXL Standard Wide (1.85:1)">1392×752</button>
                                <button type="button" class="size-preset" data-width="1568" data-height="664" title="SDXL Cinemascope (2.35:1)">1568×664</button>
                                <button type="button" class="size-preset" data-width="1576" data-height="656" title="SDXL Anamorphic (2.39:1)">1576×656</button>
                                <!-- HD preset -->
                                <button type="button" class="size-preset" data-width="1920" data-height="1080" title="Full HD (16:9)">1920×1080</button>
                            </div>
                            <!-- Custom dimensions inputs -->
                            <div class="form-row" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="custom-width">Custom Width</label>
                                    <input type="number" id="custom-width" placeholder="512" min="256" max="2048" step="8">
                                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Multiples of 8</small>
                                </div>
                                <div class="form-group">
                                    <label for="custom-height">Custom Height</label>
                                    <input type="number" id="custom-height" placeholder="512" min="256" max="2048" step="8">
                                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Multiples of 8</small>
                                </div>
                            </div>
                            <!-- Hidden inputs to store selected dimensions -->
                            <input type="hidden" id="width" value="768">
                            <input type="hidden" id="height" value="512">
                        </div>
                        
                        <!-- Steps & Guidance -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="steps">Steps</label>
                                <input type="number" id="steps" min="1" max="150" placeholder="Steps">
                            </div>
                            <div class="form-group">
                                <label for="guidance">Guidance Scale</label>
                                <input type="number" id="guidance" min="0" max="20" step="0.1" placeholder="Guidance">
                            </div>
                        </div>
                        
                        <!-- Seed & Num Images -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="seed">Seed (leave empty for random)</label>
                                <input type="number" id="seed" placeholder="Random">
                            </div>
                            <div class="form-group">
                                <label for="num-images">Number of Images</label>
                                <input type="number" id="num-images" min="1" max="100" value="1">
                            </div>
                        </div>
                        
                        <!-- Scheduler -->
                        <div class="form-group">
                            <label>Scheduler</label>
                            <div class="scheduler-grid">
                                <button type="button" class="scheduler-option" data-value="ddim">DDIM</button>
                                <button type="button" class="scheduler-option" data-value="euler">Euler</button>
                                <button type="button" class="scheduler-option" data-value="euler_a">Euler A</button>
                                <button type="button" class="scheduler-option" data-value="dpm++_sde_karras">DPM++ SDE</button>
                                <button type="button" class="scheduler-option" data-value="dpm++_karras">DPM++</button>
                                <button type="button" class="scheduler-option" data-value="lms">LMS</button>
                            </div>
                            <input type="hidden" id="scheduler" value="">
                        </div>
                        
                        <!-- Privacy Settings -->
                        <div class="form-group">
                            <label>Privacy</label>
                            <div class="privacy-toggle">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="make-public">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="privacy-label">Private (only you can see)</span>
                            </div>
                            <div id="expiration-options" style="display: none; margin-top: 0.75rem;">
                                <label for="expiration" style="font-size: 0.85rem; color: var(--text-secondary);">Expires in</label>
                                <select id="expiration" style="margin-top: 0.25rem;">
                                    <option value="24">24 hours</option>
                                    <option value="48">48 hours</option>
                                    <option value="72">3 days</option>
                                    <option value="168" selected>7 days (default)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Generate Button -->
                        <button type="submit" class="btn btn-primary btn-block btn-lg" id="generate-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            Generate Image
                        </button>
                        
                        <!-- Progress indicator -->
                        <div id="progress-container" class="progress-container" style="display: none;">
                            <div class="progress-bar" style="height: 8px;">
                                <div class="progress-fill animated" id="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progress-status">Initializing...</span>
                                <span id="progress-time">0s</span>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Generation Log -->
                    <div id="generation-log" class="generation-log" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Preview Area -->
            <div class="preview-area">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Preview
                        </span>
                        <a id="download-btn" href="#" download class="btn btn-secondary btn-sm" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download
                        </a>
                    </div>
                    
                    <div class="preview-image" id="preview-container">
                        <div class="preview-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>Generated image will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Metadata -->
                    <div id="metadata" style="display: none; margin-top: 1rem;">
                        <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.75rem;">Generation Info</div>
                        <div id="metadata-content" style="font-size: 0.875rem; color: var(--text-secondary); display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <img id="lightbox-image" src="" alt="Full size image">
        </div>
    </div>
    
    <script src="/web/app.js"></script>
    <script>
        // Lightbox functions
        function openLightbox(src) {
            document.getElementById('lightbox-image').src = src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
        
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeLightbox();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.SDAPI === 'undefined') {
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--error);">Error: ALICE JavaScript failed to load. Please refresh the page.</div>';
                return;
            }
            
            const { API, Toast, ModelSelector, requireAuth } = window.SDAPI;
            
            // Check authentication - generate is available to all authenticated users
            const authResult = await requireAuth();
            
            // Add admin class to body for CSS to show admin links
            if (authResult.isAdmin) {
                document.body.classList.add('is-admin');
            }
            
            // Check for regenerate settings from gallery
            const regenerateSettings = sessionStorage.getItem('regenerate_settings');
            if (regenerateSettings) {
                try {
                    const settings = JSON.parse(regenerateSettings);
                    sessionStorage.removeItem('regenerate_settings');
                    
                    // Pre-fill form with regenerate settings after a short delay
                    // to ensure the page is fully loaded
                    setTimeout(() => {
                        applyRegenerateSettings(settings);
                        Toast.success('Settings loaded from gallery image');
                    }, 500);
                } catch (err) {
                    console.error('Failed to parse regenerate settings:', err);
                }
            }
            
            // Load generation defaults from server
            async function loadDefaults() {
                try {
                    const defaults = await API.fetch('/v1/generation/defaults');
                    
                    // Apply defaults to form
                    document.getElementById('steps').value = defaults.steps || 25;
                    document.getElementById('guidance').value = defaults.guidance_scale || 7.5;
                    document.getElementById('width').value = defaults.width || 512;
                    document.getElementById('height').value = defaults.height || 512;
                    
                    // Update size preset selection
                    const w = defaults.width || 512;
                    const h = defaults.height || 512;
                    document.querySelectorAll('.size-preset').forEach(btn => {
                        const bw = parseInt(btn.dataset.width);
                        const bh = parseInt(btn.dataset.height);
                        if (bw === w && bh === h) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                    
                    // Update scheduler selection
                    const scheduler = defaults.scheduler || 'ddim';
                    document.querySelectorAll('.scheduler-option').forEach(btn => {
                        if (btn.dataset.value === scheduler) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                    // IMPORTANT: Also update the hidden input value!
                    document.getElementById('scheduler').value = scheduler;
                } catch (e) {
                    console.warn('Could not load generation defaults:', e);
                }
            }
            loadDefaults();
        
            // Initialize model selector
            const modelSelector = new ModelSelector('model');
            modelSelector.load().then(() => {
                // Check for model in URL params
                const params = new URLSearchParams(window.location.search);
                const modelParam = params.get('model');
                if (modelParam) {
                    document.getElementById('model').value = modelParam;
                    // Load model info for pre-selected model
                    updateResolutionPresets(modelParam);
                }
            });
            
            // Smart resolution picker - adapt presets based on model type
            async function updateResolutionPresets(modelId) {
                if (!modelId) return;
                
                try {
                    const modelInfo = await API.fetch(`/v1/models/${modelId}/info`);
                    const presets = modelInfo.recommended_resolutions || [];
                    
                    // Update the size presets container
                    const presetsContainer = document.querySelector('.size-presets');
                    const orientationToggle = document.getElementById('orientation-toggle');
                    
                    // Clear existing presets (except orientation toggle)
                    presetsContainer.querySelectorAll('.size-preset:not(#orientation-toggle)').forEach(btn => btn.remove());
                    
                    // Add new presets based on model type
                    presets.forEach(preset => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'size-preset';
                        btn.dataset.width = preset.width;
                        btn.dataset.height = preset.height;
                        btn.title = preset.label;
                        
                        // Display format: show WxH if different dimensions, otherwise just one number
                        if (preset.width === preset.height) {
                            btn.textContent = preset.width.toString();
                        } else {
                            btn.textContent = `${preset.width}×${preset.height}`;
                        }
                        
                        // Add click handler
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.size-preset').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            
                            const baseWidth = parseInt(btn.dataset.width);
                            const baseHeight = parseInt(btn.dataset.height);
                            
                            document.getElementById('width').value = baseWidth;
                            document.getElementById('height').value = baseHeight;
                            document.getElementById('custom-width').value = baseWidth;
                            document.getElementById('custom-height').value = baseHeight;
                            
                            updateOrientationLabel();
                        });
                        
                        presetsContainer.appendChild(btn);
                    });
                    
                    // Select first preset by default
                    const firstPreset = presetsContainer.querySelector('.size-preset:not(#orientation-toggle)');
                    if (firstPreset && !document.querySelector('.size-preset.selected')) {
                        firstPreset.click();
                    }
                    
                    // Log model type for debugging
                    console.log(`Model ${modelId} is ${modelInfo.model_type} (native: ${modelInfo.native_resolution})`);
                    
                } catch (error) {
                    console.error('Failed to load model info:', error);
                    // Fallback to default SD 1.5 presets if API call fails
                    // (presets are already in HTML, so just log the error)
                }
            }
            
            // Listen for model changes
            document.getElementById('model').addEventListener('change', (e) => {
                updateResolutionPresets(e.target.value);
            });
            
            // Load LoRAs (placeholder for now)
            async function loadLoras() {
                try {
                    const response = await API.fetch('/v1/loras');
                    if (response.data && response.data.length > 0) {
                        document.getElementById('lora-section').style.display = 'block';
                        const loraList = document.getElementById('lora-list');
                        loraList.innerHTML = response.data.map(lora => `
                            <div class="lora-item" data-lora="${lora.id}">
                                <input type="checkbox" id="lora-${lora.id}">
                                <div class="lora-info">
                                    <div class="lora-name">${lora.name || lora.id}</div>
                                </div>
                                <div class="lora-weight">
                                    <input type="range" min="0" max="1" step="0.1" value="0.8">
                                    <span class="lora-weight-value">0.8</span>
                                </div>
                            </div>
                        `).join('');
                        
                        // Update weight display on slider change
                        loraList.querySelectorAll('input[type="range"]').forEach(slider => {
                            slider.addEventListener('input', (e) => {
                                e.target.nextElementSibling.textContent = e.target.value;
                            });
                        });
                        
                        // Toggle selected state
                        loraList.querySelectorAll('.lora-item').forEach(item => {
                            item.addEventListener('click', (e) => {
                                if (e.target.type !== 'range' && e.target.type !== 'checkbox') {
                                    const checkbox = item.querySelector('input[type="checkbox"]');
                                    checkbox.checked = !checkbox.checked;
                                    item.classList.toggle('selected', checkbox.checked);
                                }
                            });
                        });
                    }
                } catch (e) {
                    // LoRAs not available yet
                }
            }
            loadLoras();
            
            // Size preset handlers
            document.querySelectorAll('.size-preset:not(#orientation-toggle)').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.size-preset').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    const baseWidth = parseInt(btn.dataset.width);
                    const baseHeight = parseInt(btn.dataset.height);
                    const currentOrientation = document.getElementById('orientation-label').textContent;
                    
                    // If it's a square, just use the dimensions as-is
                    if (baseWidth === baseHeight) {
                        document.getElementById('width').value = baseWidth;
                        document.getElementById('height').value = baseHeight;
                    } else {
                        // For non-square, apply current orientation
                        if (currentOrientation === 'Portrait') {
                            // Swap to portrait if base is landscape
                            if (baseWidth > baseHeight) {
                                document.getElementById('width').value = baseHeight;
                                document.getElementById('height').value = baseWidth;
                            } else {
                                document.getElementById('width').value = baseWidth;
                                document.getElementById('height').value = baseHeight;
                            }
                        } else {
                            // Use landscape orientation
                            if (baseWidth > baseHeight) {
                                document.getElementById('width').value = baseWidth;
                                document.getElementById('height').value = baseHeight;
                            } else {
                                document.getElementById('width').value = baseHeight;
                                document.getElementById('height').value = baseWidth;
                            }
                        }
                    }
                    
                    // Update custom input fields to match preset
                    document.getElementById('custom-width').value = document.getElementById('width').value;
                    document.getElementById('custom-height').value = document.getElementById('height').value;
                    
                    updateOrientationLabel();
                });
            });
            
            // Select first non-toggle preset by default
            const firstPreset = document.querySelector('.size-preset:not(#orientation-toggle)');
            if (firstPreset) {
                firstPreset.click();
            }
            
            // Orientation toggle (landscape/portrait)
            function updateOrientationLabel() {
                const width = parseInt(document.getElementById('width').value);
                const height = parseInt(document.getElementById('height').value);
                const label = document.getElementById('orientation-label');
                const btn = document.getElementById('orientation-toggle');
                
                if (width > height) {
                    label.textContent = 'Landscape';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.disabled = false;
                } else if (height > width) {
                    label.textContent = 'Portrait';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.disabled = false;
                } else {
                    label.textContent = 'Square';
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.disabled = true;
                }
            }
            
            document.getElementById('orientation-toggle').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                const widthInput = document.getElementById('width');
                const heightInput = document.getElementById('height');
                const width = parseInt(widthInput.value);
                const height = parseInt(heightInput.value);
                
                // Don't swap if square
                if (width === height) return;
                
                // Swap dimensions
                const temp = widthInput.value;
                widthInput.value = heightInput.value;
                heightInput.value = temp;
                
                // Update custom inputs to match
                document.getElementById('custom-width').value = widthInput.value;
                document.getElementById('custom-height').value = heightInput.value;
                
                updateOrientationLabel();
            });
            
            // Custom dimension inputs
            function roundToMultipleOf8(value) {
                return Math.round(value / 8) * 8;
            }
            
            document.getElementById('custom-width').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value > 0) {
                    value = roundToMultipleOf8(value);
                    value = Math.max(256, Math.min(2048, value)); // Clamp to range
                    document.getElementById('width').value = value;
                    // Clear preset selection
                    document.querySelectorAll('.size-preset').forEach(b => b.classList.remove('selected'));
                    updateOrientationLabel();
                }
            });
            
            document.getElementById('custom-height').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value > 0) {
                    value = roundToMultipleOf8(value);
                    value = Math.max(256, Math.min(2048, value)); // Clamp to range
                    document.getElementById('height').value = value;
                    // Clear preset selection
                    document.querySelectorAll('.size-preset').forEach(b => b.classList.remove('selected'));
                    updateOrientationLabel();
                }
            });
            
            // When using custom inputs, sync their display values
            document.getElementById('custom-width').addEventListener('blur', (e) => {
                const value = parseInt(document.getElementById('width').value);
                e.target.value = value || '';
            });
            
            document.getElementById('custom-height').addEventListener('blur', (e) => {
                const value = parseInt(document.getElementById('height').value);
                e.target.value = value || '';
            });
            
            // Scheduler handlers
            document.querySelectorAll('.scheduler-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.scheduler-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('scheduler').value = btn.dataset.value;
                });
            });
            
            // Privacy toggle handler
            document.getElementById('make-public').addEventListener('change', (e) => {
                const isPublic = e.target.checked;
                document.getElementById('privacy-label').textContent = isPublic 
                    ? 'Public (anyone can see)' 
                    : 'Private (only you can see)';
                document.getElementById('expiration-options').style.display = isPublic ? 'block' : 'none';
            });
            
            // Generation log helper
            function log(message, type = '') {
                const logEl = document.getElementById('generation-log');
                logEl.style.display = 'block';
                const p = document.createElement('p');
                p.className = type;
                p.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> ${message}`;
                logEl.appendChild(p);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            // Progress animation
            let progressInterval = null;
            let progressStartTime = null;
            
            function showProgress() {
                const container = document.getElementById('progress-container');
                const bar = document.getElementById('progress-bar');
                const status = document.getElementById('progress-status');
                const time = document.getElementById('progress-time');
                
                container.style.display = 'block';
                bar.style.width = '10%';
                status.textContent = 'Loading model...';
                progressStartTime = Date.now();
                
                let phase = 0;
                const phases = [
                    { at: 3, status: 'Encoding prompt...', progress: 20 },
                    { at: 5, status: 'Generating latents...', progress: 30 },
                    { at: 10, status: 'Running inference...', progress: 50 },
                    { at: 30, status: 'Still generating...', progress: 70 },
                    { at: 60, status: 'Almost there...', progress: 85 },
                    { at: 120, status: 'Taking longer than usual...', progress: 90 },
                ];
                
                progressInterval = setInterval(() => {
                    const elapsed = (Date.now() - progressStartTime) / 1000;
                    time.textContent = `${Math.floor(elapsed)}s`;
                    
                    for (let i = phases.length - 1; i >= 0; i--) {
                        if (elapsed >= phases[i].at && phase <= i) {
                            phase = i + 1;
                            status.textContent = phases[i].status;
                            bar.style.width = phases[i].progress + '%';
                            break;
                        }
                    }
                }, 500);
            }
            
            function hideProgress() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                document.getElementById('progress-container').style.display = 'none';
                document.getElementById('progress-bar').style.width = '0%';
            }
            
            // Form submission
            document.getElementById('gen-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const model = document.getElementById('model').value;
                const prompt = document.getElementById('prompt').value;
                const negativePrompt = document.getElementById('negative-prompt').value;
                const width = parseInt(document.getElementById('width').value);
                const height = parseInt(document.getElementById('height').value);
                const steps = parseInt(document.getElementById('steps').value);
                const guidance = parseFloat(document.getElementById('guidance').value);
                const seed = document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null;
                const scheduler = document.getElementById('scheduler').value;
                const numImages = parseInt(document.getElementById('num-images').value) || 1;
                
                // Collect selected LoRAs
                const loraPaths = [];
                const loraScales = [];
                document.querySelectorAll('.lora-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox && checkbox.checked) {
                        loraPaths.push(item.dataset.lora);
                        const slider = item.querySelector('input[type="range"]');
                        loraScales.push(parseFloat(slider?.value || 0.8));
                    }
                });
                
                if (!model) {
                    Toast.error('Please select a model');
                    return;
                }
                
                const btn = document.getElementById('generate-btn');
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Generating...';
                
                // Add cancel button
                let cancelBtn = document.getElementById('cancel-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-btn';
                    cancelBtn.className = 'btn btn-secondary';
                    cancelBtn.style.marginLeft = '0.5rem';
                    cancelBtn.innerHTML = 'Cancel';
                    btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
                }
                cancelBtn.style.display = 'inline-flex';
                
                let cancelled = false;
                cancelBtn.onclick = () => {
                    cancelled = true;
                    log('Generation cancelled by user', 'warning');
                    Toast.warning('Generation cancelled');
                };
                
                showProgress();
                
                // Clear log
                document.getElementById('generation-log').innerHTML = '';
                log('Starting generation...', 'info');
                log(`Model: ${model}`);
                log(`Size: ${width}x${height}, Steps: ${steps}, Guidance: ${guidance}`);
                if (numImages > 1) {
                    log(`Generating ${numImages} images sequentially...`);
                }
                if (loraPaths.length > 0) {
                    log(`LoRAs: ${loraPaths.join(', ')}`);
                }
                
                try {
                    const startTime = Date.now();
                    const allImageUrls = [];
                    let lastMetadata = null;
                    
                    // Generate images one at a time
                    for (let i = 0; i < numImages; i++) {
                        if (cancelled) break;
                        
                        if (numImages > 1) {
                            log(`Generating image ${i + 1} of ${numImages}...`, 'info');
                        }
                        
                        const response = await API.generate(model, prompt, {
                            negativePrompt,
                            width,
                            height,
                            steps,
                            guidanceScale: guidance,
                            seed: i === 0 ? seed : null,  // Use seed only for first image, random for rest
                            scheduler,
                            numImages: 1,
                            loraPaths: loraPaths.length > 0 ? loraPaths : null,
                            loraScales: loraScales.length > 0 ? loraScales : null
                        });
                        
                        if (response.choices && response.choices[0]) {
                            const message = response.choices[0].message;
                            const imageUrls = message.image_urls || [];
                            allImageUrls.push(...imageUrls);
                            lastMetadata = message.metadata;
                            
                            if (numImages > 1) {
                                log(`Image ${i + 1} completed`, 'success');
                            }
                        }
                    }
                    
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    if (cancelled) {
                        log(`Cancelled after ${allImageUrls.length} of ${numImages} images (${elapsed}s)`, 'warning');
                    } else {
                        log(`All ${allImageUrls.length} images completed in ${elapsed}s`, 'success');
                    }
                    
                    const imageUrls = allImageUrls;
                    const metadata = lastMetadata;
                    
                    if (imageUrls.length > 0) {
                            // Show preview - display all images
                            const container = document.getElementById('preview-container');
                            container.classList.add('has-image');
                            
                            if (imageUrls.length === 1) {
                                // Single image - show large
                                container.innerHTML = `<img src="${imageUrls[0]}" alt="Generated image" onclick="openLightbox('${imageUrls[0]}')">`;
                            } else {
                                // Multiple images - show grid
                                container.innerHTML = `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                        ${imageUrls.map(url => `<img src="${url}" alt="Generated image" onclick="openLightbox('${url}')" style="width: 100%; cursor: pointer;">`).join('')}
                                    </div>
                                `;
                            }
                            
                            // Show download button for first image
                            const downloadBtn = document.getElementById('download-btn');
                            downloadBtn.href = imageUrls[0];
                            downloadBtn.style.display = 'inline-flex';
                            
                            // Update privacy if user selected public
                            const makePublic = document.getElementById('make-public').checked;
                            if (makePublic) {
                                const expirationHours = parseInt(document.getElementById('expiration').value);
                                // Set privacy for all generated images
                                for (const imageUrl of imageUrls) {
                                    const imageId = imageUrl.split('/').pop().replace(/\.[^.]+$/, '');
                                    try {
                                        await API.fetch(`/v1/gallery/${imageId}/privacy`, {
                                            method: 'PATCH',
                                            body: JSON.stringify({ 
                                                isPublic: true, 
                                                expiresInHours: expirationHours 
                                            })
                                        });
                                    } catch (privacyError) {
                                        log(`Warning: Could not set privacy for ${imageId}: ${privacyError.message}`, 'warning');
                                    }
                                }
                                log(`${imageUrls.length} image(s) set to public (expires in ${expirationHours}h)`, 'info');
                            }
                            
                            // Show metadata
                            if (metadata) {
                                document.getElementById('metadata').style.display = 'block';
                                document.getElementById('metadata-content').innerHTML = `
                                    <div><strong>Seed:</strong> ${metadata.seed || 'N/A'}</div>
                                    <div><strong>Scheduler:</strong> ${metadata.scheduler}</div>
                                    <div><strong>Steps:</strong> ${metadata.steps}</div>
                                    <div><strong>Guidance:</strong> ${metadata.guidance_scale}</div>
                                    <div><strong>Size:</strong> ${metadata.width}x${metadata.height}</div>
                                    <div><strong>Time:</strong> ${elapsed}s</div>
                                `;
                                
                                // Update seed field if it was random
                                if (!document.getElementById('seed').value && metadata.seed) {
                                    document.getElementById('seed').value = metadata.seed;
                                }
                            }
                            
                            Toast.success(`${imageUrls.length} image(s) generated!`);
                        }
                } catch (error) {
                    log(`Error: ${error.message}`, 'error');
                    Toast.error(`Generation failed: ${error.message}`);
                } finally {
                    hideProgress();
                    btn.disabled = false;
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg> Generate Image`;
                    const cancelBtn = document.getElementById('cancel-btn');
                    if (cancelBtn) cancelBtn.style.display = 'none';
                }
            });
            
            // Function to apply regenerate settings from gallery
            function applyRegenerateSettings(settings) {
                // Set prompt fields
                if (settings.prompt) {
                    document.getElementById('prompt').value = settings.prompt;
                }
                if (settings.negativePrompt) {
                    document.getElementById('negative-prompt').value = settings.negativePrompt;
                }
                
                // Set model
                if (settings.model) {
                    const modelSelect = document.getElementById('model');
                    modelSelect.value = settings.model;
                }
                
                // Set dimensions
                if (settings.width && settings.height) {
                    document.getElementById('width').value = settings.width;
                    document.getElementById('height').value = settings.height;
                    
                    // Update custom inputs if present
                    const customWidth = document.getElementById('custom-width');
                    const customHeight = document.getElementById('custom-height');
                    if (customWidth) customWidth.value = settings.width;
                    if (customHeight) customHeight.value = settings.height;
                    
                    // Update size preset selection
                    document.querySelectorAll('.size-preset').forEach(btn => {
                        const bw = parseInt(btn.dataset.width);
                        const bh = parseInt(btn.dataset.height);
                        if (bw === settings.width && bh === settings.height) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                }
                
                // Set generation parameters
                if (settings.steps !== undefined) {
                    document.getElementById('steps').value = settings.steps;
                }
                if (settings.guidanceScale !== undefined) {
                    document.getElementById('guidance').value = settings.guidanceScale;
                }
                if (settings.seed !== undefined) {
                    document.getElementById('seed').value = settings.seed;
                }
                
                // Set scheduler
                if (settings.scheduler) {
                    document.getElementById('scheduler').value = settings.scheduler;
                    document.querySelectorAll('.scheduler-option').forEach(btn => {
                        if (btn.dataset.value === settings.scheduler) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                }
                
                // LoRAs would go here if implemented
                // For now, just log if they exist
                if (settings.loras && settings.loras.length > 0) {
                    console.log('LoRAs from regenerate:', settings.loras, settings.loraScales);
                    // TODO: Apply LoRAs when LoRA UI is fully implemented
                }
            }
        }); // End DOMContentLoaded
    </script>
</body>
</html>
