<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate - ALICE</title>
    <link rel="stylesheet" href="/web/fonts/inter.css">
    <link rel="stylesheet" href="/web/style.css">
    <style>
        .gen-container {
            display: grid;
            grid-template-columns: 600px 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        
        .form-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .form-column-full {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 1200px) {
            .gen-container {
                grid-template-columns: 1fr;
            }
            .form-columns {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 1024px) {
            .preview-area {
                position: static !important;
            }
        }
        
        /* Privacy toggle */
        .privacy-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        #privacy-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Size preset dropdown styling */
        .size-control-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .size-control-row > div:first-child {
            flex: 1;
        }
        
        #orientation-toggle {
            padding: 0.65rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        
        #orientation-toggle:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }
        
        #orientation-toggle:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-brand">
            <a href="/web/" class="logo"><img src="/web/alice-logo.png" alt="ALICE" style="height: 40px; width: auto; display: inline-block; margin-right: 8px; vertical-align: middle;"><span style="display: inline-block; vertical-align: middle; font-weight: 700; font-size: 1.2rem; color: var(--accent);">ALICE</span></a>
        </div>
        <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('open')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <div class="nav-links">
            <a href="/web/" class="admin-only">Dashboard</a>
            <a href="/web/models.html" class="admin-only">Models</a>
            <a href="/web/generate.html" class="active">Generate</a>
            <a href="/web/gallery.html">Gallery</a>
            <a href="/web/prompting.html">Prompting Guide</a>
            <a href="/web/download.html" class="admin-only">Download</a>
            <a href="/web/admin.html" class="admin-only">Admin</a>
            <a href="/docs" target="_blank">API Docs</a>
            <a href="/web/login.html" class="login-link">Login</a>
            <a href="#" onclick="window.SDAPI.logout(); return false;" class="logout-link">Logout</a>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </nav>
    
    <main>
        <div class="page-header">
            <h1>Generate Image</h1>
            <p>Create stunning images with Stable Diffusion</p>
        </div>
        
        <div class="gen-container">
            <!-- Generation Form -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Generation Settings
                    </span>
                </div>
                
                <form id="gen-form" class="gen-form">
                    <!-- Model Selection - Full Width -->
                    <div class="form-group form-column-full">
                        <label for="model">Model</label>
                        <select id="model" required>
                            <option value="" disabled selected>Loading models...</option>
                        </select>
                    </div>
                    
                    <!-- Prompt - Full Width -->
                    <div class="form-group form-column-full">
                        <label for="prompt">Prompt</label>
                        <textarea id="prompt" rows="4" placeholder="A serene mountain landscape at sunset, detailed, photorealistic, 8k" required></textarea>
                    </div>
                    
                    <!-- Negative Prompt - Full Width -->
                    <div class="form-group form-column-full">
                        <label for="negative-prompt">Negative Prompt</label>
                        <textarea id="negative-prompt" rows="2" placeholder="blurry, low quality, distorted, ugly"></textarea>
                    </div>
                    
                    <!-- LoRA Section - Full Width -->
                    <div class="form-group form-column-full" id="lora-section" style="display: none;">
                        <label>LoRA Models</label>
                        <div id="lora-list" class="lora-list"></div>
                    </div>
                    
                    <!-- Image-to-Image Input Section - Full Width -->
                    <div class="form-group form-column-full" id="img2img-section">
                        <label>Input Images (img2img)</label>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Upload reference images for image editing models (e.g., Qwen-Image-Edit). Leave empty for text-to-image.
                        </p>
                        <div id="img2img-upload-area" style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: border-color 0.2s, background-color 0.2s;">
                            <input type="file" id="img2img-file-input" accept="image/*" multiple style="display: none;">
                            <div id="img2img-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="var(--text-secondary)" style="margin-bottom: 0.5rem;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">Click or drag images here</p>
                            </div>
                            <div id="img2img-previews" style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;"></div>
                        </div>
                        <button type="button" id="img2img-clear-btn" style="display: none; margin-top: 0.5rem; width: 100%; background: var(--danger-color, #dc3545); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                            Clear Input Images
                        </button>
                    </div>
                    
                    <!-- Two Column Layout for Basic/Advanced Settings -->
                    <div class="form-columns">
                        <!-- LEFT COLUMN: Basic Settings -->
                        <div>
                            <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Settings</h3>
                            
                            <!-- Size Presets Dropdown -->
                            <div class="form-group">
                                <label for="size-preset">Resolution</label>
                                <select id="size-preset" class="form-select">
                                    <optgroup label="SD 1.5">
                                        <option value="512x512">512×512 (Square)</option>
                                        <option value="768x512" selected>768×512 (Landscape 3:2)</option>
                                        <option value="768x768">768×768 (Large Square)</option>
                                    </optgroup>
                                    <optgroup label="SDXL Portrait">
                                        <option value="832x1248">832×1248 (2:3)</option>
                                        <option value="880x1176">880×1176 (3:4)</option>
                                        <option value="912x1144">912×1144 (4:5)</option>
                                    </optgroup>
                                    <optgroup label="SDXL Square">
                                        <option value="1024x1024">1024×1024 (Square)</option>
                                    </optgroup>
                                    <optgroup label="SDXL Landscape">
                                        <option value="1176x880">1176×880 (SD TV 4:3)</option>
                                        <option value="1224x856">1224×856 (IMAX 1.43:1)</option>
                                        <option value="1296x800">1296×800 (Golden Ratio)</option>
                                        <option value="1312x792">1312×792 (European Wide)</option>
                                    </optgroup>
                                    <optgroup label="SDXL Widescreen">
                                        <option value="1360x768">1360×768 (16:9 HD)</option>
                                        <option value="1392x752">1392×752 (1.85:1)</option>
                                        <option value="1568x664">1568×664 (Cinemascope)</option>
                                        <option value="1576x656">1576×656 (Anamorphic)</option>
                                    </optgroup>
                                    <optgroup label="HD">
                                        <option value="1920x1080">1920×1080 (Full HD)</option>
                                    </optgroup>
                                    <optgroup label="Custom">
                                        <option value="custom">Custom Size</option>
                                    </optgroup>
                                </select>
                                <button type="button" id="orientation-toggle" title="Switch between landscape and portrait" style="margin-top: 0.5rem; width: 100%;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    <span id="orientation-label">Landscape</span>
                                </button>
                                <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 0.25rem;">Auto-rounded to multiples of 8</small>
                            </div>
                            
                            <!-- Custom Size Inputs (shown when custom selected) -->
                            <div id="custom-size-inputs" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="custom-width">Width</label>
                                        <input type="number" id="custom-width" placeholder="768" min="256" max="2048" step="8">
                                    </div>
                                    <div class="form-group">
                                        <label for="custom-height">Height</label>
                                        <input type="number" id="custom-height" placeholder="512" min="256" max="2048" step="8">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden inputs to store selected dimensions -->
                            <input type="hidden" id="width" value="768">
                            <input type="hidden" id="height" value="512">
                            
                            <!-- Number of Images -->
                            <div class="form-group">
                                <label for="num-images">Number of Images</label>
                                <input type="number" id="num-images" min="1" max="100" value="1">
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Advanced Settings -->
                        <div>
                            <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Advanced Settings</h3>
                            
                            <!-- Steps & Guidance -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="steps">Steps</label>
                                    <input type="number" id="steps" min="1" max="150" placeholder="25">
                                </div>
                                <div class="form-group">
                                    <label for="guidance">Guidance</label>
                                    <input type="number" id="guidance" min="0" max="20" step="0.1" placeholder="7.5">
                                </div>
                            </div>
                            
                            <!-- Seed -->
                            <div class="form-group">
                                <label for="seed">Seed (leave empty for random)</label>
                                <input type="number" id="seed" placeholder="Random">
                            </div>
                            
                            <!-- Scheduler -->
                            <div class="form-group">
                                <label>Scheduler</label>
                                <div class="scheduler-grid">
                                    <button type="button" class="scheduler-option" data-value="ddim">DDIM</button>
                                    <button type="button" class="scheduler-option" data-value="euler">Euler</button>
                                    <button type="button" class="scheduler-option" data-value="euler_a">Euler A</button>
                                    <button type="button" class="scheduler-option" data-value="dpm++_sde_karras">DPM++ SDE</button>
                                    <button type="button" class="scheduler-option" data-value="dpm++_karras">DPM++</button>
                                    <button type="button" class="scheduler-option" data-value="lms">LMS</button>
                                </div>
                                <input type="hidden" id="scheduler" value="">
                            </div>
                            
                            <!-- Privacy Settings -->
                            <div class="form-group">
                                <label>Privacy</label>
                                <div class="privacy-toggle">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="make-public">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span id="privacy-label">Private (only you can see)</span>
                                </div>
                                <div id="expiration-options" style="display: none; margin-top: 0.75rem;">
                                    <label for="expiration" style="font-size: 0.85rem; color: var(--text-secondary);">Expires in</label>
                                    <select id="expiration" style="margin-top: 0.25rem;">
                                        <option value="24">24 hours</option>
                                        <option value="48">48 hours</option>
                                        <option value="72">3 days</option>
                                        <option value="168" selected>7 days (default)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button - Full Width -->
                    <button type="submit" class="btn btn-primary btn-block btn-lg form-column-full" id="generate-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Generate Image
                    </button>
                </form>
                
                <!-- Progress Bar -->
                <div id="progress-container" style="display: none; margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span id="progress-status" style="font-size: 0.9rem; color: var(--text-secondary);">Generating...</span>
                        <span id="progress-time" style="font-size: 0.85rem; color: var(--text-muted);"></span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <!-- Generation Log -->
                <div id="generation-log" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; max-height: 200px; overflow-y: auto; font-size: 0.85rem; font-family: 'Courier New', monospace;"></div>
            </div>
            
            <!-- Preview Area -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Preview
                        </span>
                        <a id="download-btn" href="#" download class="btn btn-secondary btn-sm" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download
                        </a>
                    </div>
                    
                    <div class="preview-image" id="preview-container">
                        <div class="preview-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>Generated image will appear here</p>
                        </div>
                    </div>
                    
                    <!-- Metadata -->
                    <div id="metadata" style="display: none; margin-top: 1rem;">
                        <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.75rem;">Generation Info</div>
                        <div id="metadata-content" style="font-size: 0.875rem; color: var(--text-secondary); display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <img id="lightbox-image" src="" alt="Full size image">
        </div>
    </div>
    
    <script src="/web/app.js"></script>
    <script>
        // Lightbox functions
        function openLightbox(src) {
            document.getElementById('lightbox-image').src = src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
        
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeLightbox();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.SDAPI === 'undefined') {
                document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--error);">Error: ALICE JavaScript failed to load. Please refresh the page.</div>';
                return;
            }
            
            const { API, Toast, ModelSelector, requireAuth } = window.SDAPI;
            
            // Check authentication - generate is available to all authenticated users
            const authResult = await requireAuth();
            
            // Add admin class to body for CSS to show admin links
            if (authResult.isAdmin) {
                document.body.classList.add('is-admin');
            }
            
            // Check for regenerate settings from gallery
            const regenerateSettings = sessionStorage.getItem('regenerate_settings');
            if (regenerateSettings) {
                try {
                    const settings = JSON.parse(regenerateSettings);
                    sessionStorage.removeItem('regenerate_settings');
                    
                    // Pre-fill form with regenerate settings after a short delay
                    // to ensure the page is fully loaded
                    setTimeout(() => {
                        applyRegenerateSettings(settings);
                        Toast.success('Settings loaded from gallery image');
                    }, 500);
                } catch (err) {
                    console.error('Failed to parse regenerate settings:', err);
                }
            }
            
            // Load generation defaults from server
            async function loadDefaults() {
                try {
                    const defaults = await API.fetch('/v1/generation/defaults');
                    
                    // Apply defaults to form
                    document.getElementById('steps').value = defaults.steps || 25;
                    document.getElementById('guidance').value = defaults.guidance_scale || 7.5;
                    document.getElementById('width').value = defaults.width || 768;
                    document.getElementById('height').value = defaults.height || 512;
                    
                    // Update size preset dropdown selection
                    const w = defaults.width || 768;
                    const h = defaults.height || 512;
                    const presetValue = `${w}x${h}`;
                    const presetSelect = document.getElementById('size-preset');
                    const option = Array.from(presetSelect.options).find(opt => opt.value === presetValue);
                    if (option) {
                        presetSelect.value = presetValue;
                    }
                    updateOrientationLabel();
                    
                    // Update scheduler selection
                    const scheduler = defaults.scheduler || 'ddim';
                    document.querySelectorAll('.scheduler-option').forEach(btn => {
                        if (btn.dataset.value === scheduler) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                    // IMPORTANT: Also update the hidden input value!
                    document.getElementById('scheduler').value = scheduler;
                } catch (e) {
                    console.warn('Could not load generation defaults:', e);
                }
            }
            loadDefaults();
        
            // ============================================================
            // Image-to-Image Upload Handler
            // ============================================================
            const img2imgInputFiles = [];  // Store File objects for encoding later
            
            const uploadArea = document.getElementById('img2img-upload-area');
            const fileInput = document.getElementById('img2img-file-input');
            const previewsContainer = document.getElementById('img2img-previews');
            const placeholder = document.getElementById('img2img-placeholder');
            const clearBtn = document.getElementById('img2img-clear-btn');
            
            // Click to upload
            uploadArea.addEventListener('click', (e) => {
                if (e.target.closest('#img2img-clear-btn')) return;
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--accent-color, #0ea5e9)';
                uploadArea.style.backgroundColor = 'rgba(14, 165, 233, 0.05)';
            });
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border-color)';
                uploadArea.style.backgroundColor = '';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border-color)';
                uploadArea.style.backgroundColor = '';
                if (e.dataTransfer.files.length > 0) {
                    handleImg2ImgFiles(e.dataTransfer.files);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleImg2ImgFiles(fileInput.files);
                }
            });
            
            // Clear button
            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                img2imgInputFiles.length = 0;
                previewsContainer.innerHTML = '';
                placeholder.style.display = '';
                clearBtn.style.display = 'none';
                fileInput.value = '';
            });
            
            function handleImg2ImgFiles(files) {
                for (const file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    img2imgInputFiles.push(file);
                    
                    // Create preview thumbnail
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const thumb = document.createElement('div');
                        thumb.style.cssText = 'position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color);';
                        thumb.innerHTML = `
                            <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
                            <button type="button" style="position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1; display: flex; align-items: center; justify-content: center;" onclick="this.parentElement.remove(); window._removeImg2ImgFile(${img2imgInputFiles.length - 1});">×</button>
                        `;
                        previewsContainer.appendChild(thumb);
                    };
                    reader.readAsDataURL(file);
                }
                placeholder.style.display = 'none';
                clearBtn.style.display = '';
            }
            
            // Global helper for removing individual images
            window._removeImg2ImgFile = function(index) {
                img2imgInputFiles.splice(index, 1);
                if (img2imgInputFiles.length === 0) {
                    placeholder.style.display = '';
                    clearBtn.style.display = 'none';
                }
            };
            
            // Helper: convert File to base64 string
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);  // returns data:image/...;base64,...
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        
            // Initialize model selector
            const modelSelector = new ModelSelector('model');
            modelSelector.load().then(() => {
                // Check for model in URL params
                const params = new URLSearchParams(window.location.search);
                const modelParam = params.get('model');
                if (modelParam) {
                    document.getElementById('model').value = modelParam;
                    // Load model info for pre-selected model
                    updateResolutionPresets(modelParam);
                }
            });
            
            // Smart resolution picker - adapt presets based on model type
            async function updateResolutionPresets(modelId) {
                // This is a placeholder for future enhancement
                // Could highlight recommended resolutions based on model type
            }
            
            // Monitor model changes
            document.getElementById('model').addEventListener('change', (e) => {
                updateResolutionPresets(e.target.value);
            });
            
            // Load LoRA models if available
            async function loadLoras() {
                try {
                    const response = await API.fetch('/v1/models/loras');
                    if (response && response.loras && response.loras.length > 0) {
                        const loraSection = document.getElementById('lora-section');
                        const loraList = document.getElementById('lora-list');
                        
                        loraSection.style.display = 'block';
                        loraList.innerHTML = '';
                        
                        response.loras.forEach(lora => {
                            const loraItem = document.createElement('div');
                            loraItem.className = 'lora-item';
                            loraItem.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <input type="checkbox" class="lora-checkbox" data-name="${lora.name}" style="width: 18px; height: 18px;">
                                    <span style="flex: 1; font-weight: 500;">${lora.name}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                    <label style="font-size: 0.85rem; color: var(--text-secondary);">Weight:</label>
                                    <input type="range" class="lora-weight" min="0" max="2" step="0.1" value="1" disabled style="flex: 1;">
                                    <span class="lora-weight-value" style="font-size: 0.85rem; min-width: 2rem;">1.0</span>
                                </div>
                            `;
                            loraList.appendChild(loraItem);
                        });
                        
                        // Enable weight slider when checkbox is checked
                        loraList.querySelectorAll('.lora-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', (e) => {
                                const item = e.target.closest('.lora-item');
                                const weightSlider = item.querySelector('.lora-weight');
                                weightSlider.disabled = !e.target.checked;
                                item.classList.toggle('selected', e.target.checked);
                            });
                        });
                        
                        // Update weight value display
                        loraList.querySelectorAll('.lora-weight').forEach(slider => {
                            slider.addEventListener('input', (e) => {
                                const item = e.target.closest('.lora-item');
                                const valueDisplay = item.querySelector('.lora-weight-value');
                                valueDisplay.textContent = parseFloat(e.target.value).toFixed(1);
                            });
                        });
                        
                        // Toggle selected state
                        loraList.querySelectorAll('.lora-item').forEach(item => {
                            item.addEventListener('click', (e) => {
                                if (e.target.type !== 'range' && e.target.type !== 'checkbox') {
                                    const checkbox = item.querySelector('input[type="checkbox"]');
                                    checkbox.checked = !checkbox.checked;
                                    item.classList.toggle('selected', checkbox.checked);
                                }
                            });
                        });
                    }
                } catch (e) {
                    // LoRAs not available yet
                }
            }
            loadLoras();
            
            // Size preset dropdown handler
            document.getElementById('size-preset').addEventListener('change', (e) => {
                const value = e.target.value;
                const customInputs = document.getElementById('custom-size-inputs');
                
                if (value === 'custom') {
                    customInputs.style.display = 'block';
                    // Set custom inputs to current hidden values
                    document.getElementById('custom-width').value = document.getElementById('width').value;
                    document.getElementById('custom-height').value = document.getElementById('height').value;
                } else {
                    customInputs.style.display = 'none';
                    const [width, height] = value.split('x').map(Number);
                    document.getElementById('width').value = width;
                    document.getElementById('height').value = height;
                    updateOrientationLabel();
                }
            });
            
            // Orientation toggle (landscape/portrait)
            function updateOrientationLabel() {
                const width = parseInt(document.getElementById('width').value);
                const height = parseInt(document.getElementById('height').value);
                const label = document.getElementById('orientation-label');
                const btn = document.getElementById('orientation-toggle');
                
                if (width > height) {
                    label.textContent = 'Landscape';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                } else if (height > width) {
                    label.textContent = 'Portrait';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                } else {
                    label.textContent = 'Square';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                }
            }
            
            document.getElementById('orientation-toggle').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                const widthInput = document.getElementById('width');
                const heightInput = document.getElementById('height');
                const width = parseInt(widthInput.value);
                const height = parseInt(heightInput.value);
                
                // Don't swap if square
                if (width === height) return;
                
                // Swap dimensions
                const temp = widthInput.value;
                widthInput.value = heightInput.value;
                heightInput.value = temp;
                
                // Update custom inputs if visible
                if (document.getElementById('custom-size-inputs').style.display !== 'none') {
                    document.getElementById('custom-width').value = widthInput.value;
                    document.getElementById('custom-height').value = heightInput.value;
                }
                
                // Update dropdown selection to match new orientation
                const newPresetValue = `${widthInput.value}x${heightInput.value}`;
                const presetSelect = document.getElementById('size-preset');
                const option = Array.from(presetSelect.options).find(opt => opt.value === newPresetValue);
                if (option) {
                    presetSelect.value = newPresetValue;
                } else {
                    presetSelect.value = 'custom';
                    document.getElementById('custom-size-inputs').style.display = 'block';
                }
                
                updateOrientationLabel();
            });
            
            // Custom dimension inputs
            function roundToMultipleOf8(value) {
                return Math.round(value / 8) * 8;
            }
            
            document.getElementById('custom-width').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value > 0) {
                    value = roundToMultipleOf8(value);
                    value = Math.max(256, Math.min(2048, value)); // Clamp to range
                    document.getElementById('width').value = value;
                    updateOrientationLabel();
                }
            });
            
            document.getElementById('custom-height').addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value > 0) {
                    value = roundToMultipleOf8(value);
                    value = Math.max(256, Math.min(2048, value)); // Clamp to range
                    document.getElementById('height').value = value;
                    updateOrientationLabel();
                }
            });
            
            // When using custom inputs, sync their display values
            document.getElementById('custom-width').addEventListener('blur', (e) => {
                const value = parseInt(document.getElementById('width').value);
                e.target.value = value || '';
            });
            
            document.getElementById('custom-height').addEventListener('blur', (e) => {
                const value = parseInt(document.getElementById('height').value);
                e.target.value = value || '';
            });
            
            // Scheduler handlers
            document.querySelectorAll('.scheduler-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.scheduler-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('scheduler').value = btn.dataset.value;
                });
            });
            
            // Privacy toggle handler
            document.getElementById('make-public').addEventListener('change', (e) => {
                const isPublic = e.target.checked;
                document.getElementById('privacy-label').textContent = isPublic 
                    ? 'Public (anyone can see)' 
                    : 'Private (only you can see)';
                document.getElementById('expiration-options').style.display = isPublic ? 'block' : 'none';
            });
            
            // Generation log helper
            function log(message, type = '') {
                const logEl = document.getElementById('generation-log');
                logEl.style.display = 'block';
                const p = document.createElement('p');
                p.className = type;
                p.innerHTML = `<span class="timestamp">[${new Date().toLocaleTimeString()}]</span> ${message}`;
                logEl.appendChild(p);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            // Progress animation
            let progressInterval = null;
            let progressStartTime = null;
            
            function showProgress() {
                const container = document.getElementById('progress-container');
                const bar = document.getElementById('progress-bar');
                const status = document.getElementById('progress-status');
                const time = document.getElementById('progress-time');
                
                container.style.display = 'block';
                bar.style.width = '10%';
                status.textContent = 'Loading model...';
                progressStartTime = Date.now();
                
                let phase = 0;
                const phases = [
                    { at: 3, status: 'Encoding prompt...', progress: 20 },
                    { at: 5, status: 'Generating latents...', progress: 30 },
                    { at: 10, status: 'Running inference...', progress: 50 },
                    { at: 30, status: 'Still generating...', progress: 70 },
                    { at: 60, status: 'Almost there...', progress: 85 },
                    { at: 120, status: 'Taking longer than usual...', progress: 90 },
                ];
                
                progressInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - progressStartTime) / 1000);
                    time.textContent = `${elapsed}s`;
                    
                    if (phase < phases.length && elapsed >= phases[phase].at) {
                        status.textContent = phases[phase].status;
                        bar.style.width = phases[phase].progress + '%';
                        phase++;
                    }
                }, 100);
            }
            
            function hideProgress() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                document.getElementById('progress-container').style.display = 'none';
            }
            
            // Form submission
            document.getElementById('gen-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const generateBtn = document.getElementById('generate-btn');
                const originalBtnText = generateBtn.innerHTML;
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<svg class="spinner" width="20" height="20" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)"><animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></circle></svg> Generating...';
                
                showProgress();
                
                // Clear previous preview
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '<div class="preview-placeholder"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><p>Generating...</p></div>';
                document.getElementById('metadata').style.display = 'none';
                document.getElementById('download-btn').style.display = 'none';
                
                try {
                    // Gather form data
                    const formData = {
                        model: document.getElementById('model').value,
                        prompt: document.getElementById('prompt').value,
                        negative_prompt: document.getElementById('negative-prompt').value || undefined,
                        width: parseInt(document.getElementById('width').value),
                        height: parseInt(document.getElementById('height').value),
                        steps: parseInt(document.getElementById('steps').value) || undefined,
                        guidance_scale: parseFloat(document.getElementById('guidance').value) || undefined,
                        scheduler: document.getElementById('scheduler').value || undefined,
                        seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : undefined,
                        num_images: parseInt(document.getElementById('num-images').value) || 1,
                    };
                    
                    // Add LoRAs if any selected
                    const selectedLoras = [];
                    document.querySelectorAll('.lora-checkbox:checked').forEach(checkbox => {
                        const item = checkbox.closest('.lora-item');
                        const weight = parseFloat(item.querySelector('.lora-weight').value);
                        selectedLoras.push({
                            name: checkbox.dataset.name,
                            weight: weight
                        });
                    });
                    if (selectedLoras.length > 0) {
                        formData.loras = selectedLoras;
                    }
                    
                    // Add privacy settings
                    const isPublic = document.getElementById('make-public').checked;
                    if (isPublic) {
                        formData.privacy = 'public';
                        formData.expiration_hours = parseInt(document.getElementById('expiration').value);
                    } else {
                        formData.privacy = 'private';
                    }
                    
                    // Add img2img input images if any
                    if (img2imgInputFiles.length > 0) {
                        log(`Encoding ${img2imgInputFiles.length} input image(s) for img2img...`);
                        const base64Images = await Promise.all(img2imgInputFiles.map(f => fileToBase64(f)));
                        formData.input_images = base64Images;
                        log(`img2img mode: ${img2imgInputFiles.length} image(s) encoded`, 'info');
                    }
                    
                    log(`Starting generation with ${formData.model}...`);
                    log(`Resolution: ${formData.width}x${formData.height}, Steps: ${formData.steps || 'default'}, Scheduler: ${formData.scheduler || 'default'}`);
                    
                    const startTime = Date.now();
                    const response = await API.generateImage(formData);
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    
                    hideProgress();
                    
                    if (response && response.url) {
                        log(` Generation complete in ${elapsed}s`, 'success');
                        
                        // Display image
                        previewContainer.innerHTML = `
                            <img src="${response.url}" alt="Generated image" onclick="openLightbox('${response.url}')" style="cursor: pointer; width: 100%; height: auto; border-radius: 8px;">
                        `;
                        
                        // Setup download button
                        const downloadBtn = document.getElementById('download-btn');
                        downloadBtn.href = response.url;
                        downloadBtn.download = `alice-${Date.now()}.png`;
                        downloadBtn.style.display = 'flex';
                        
                        // Display metadata
                        if (response.metadata) {
                            const metadataEl = document.getElementById('metadata-content');
                            metadataEl.innerHTML = `
                                <div><strong>Seed:</strong> ${response.metadata.seed || 'N/A'}</div>
                                <div><strong>Steps:</strong> ${response.metadata.steps || formData.steps || 'N/A'}</div>
                                <div><strong>Guidance:</strong> ${response.metadata.guidance_scale || formData.guidance_scale || 'N/A'}</div>
                                <div><strong>Scheduler:</strong> ${response.metadata.scheduler || formData.scheduler || 'N/A'}</div>
                                <div><strong>Size:</strong> ${formData.width}×${formData.height}</div>
                                <div><strong>Time:</strong> ${elapsed}s</div>
                            `;
                            document.getElementById('metadata').style.display = 'block';
                        }
                        
                        Toast.success(`Image generated successfully in ${elapsed}s`);
                    } else {
                        throw new Error('Invalid response from server');
                    }
                } catch (error) {
                    hideProgress();
                    log(` Error: ${error.message}`, 'error');
                    Toast.error('Generation failed: ' + error.message);
                    previewContainer.innerHTML = '<div class="preview-placeholder" style="color: var(--error);"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><p>Generation failed</p><p style="font-size: 0.85rem; margin-top: 0.5rem;">' + error.message + '</p></div>';
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalBtnText;
                }
            });
            
            // Apply regenerate settings (from gallery)
            function applyRegenerateSettings(settings) {
                if (settings.model) document.getElementById('model').value = settings.model;
                if (settings.prompt) document.getElementById('prompt').value = settings.prompt;
                
                // Handle both naming conventions: negativePrompt (camelCase) and negative_prompt (snake_case)
                const negativePrompt = settings.negativePrompt || settings.negative_prompt;
                if (negativePrompt) document.getElementById('negative-prompt').value = negativePrompt;
                
                if (settings.width && settings.height) {
                    document.getElementById('width').value = settings.width;
                    document.getElementById('height').value = settings.height;
                    
                    // Try to match preset
                    const presetValue = `${settings.width}x${settings.height}`;
                    const presetSelect = document.getElementById('size-preset');
                    const option = Array.from(presetSelect.options).find(opt => opt.value === presetValue);
                    if (option) {
                        presetSelect.value = presetValue;
                    } else {
                        presetSelect.value = 'custom';
                        document.getElementById('custom-size-inputs').style.display = 'block';
                        document.getElementById('custom-width').value = settings.width;
                        document.getElementById('custom-height').value = settings.height;
                    }
                    updateOrientationLabel();
                }
                if (settings.steps) document.getElementById('steps').value = settings.steps;
                
                // Handle both naming conventions: guidanceScale (camelCase) and guidance_scale (snake_case)
                const guidanceScale = settings.guidanceScale !== undefined ? settings.guidanceScale : settings.guidance_scale;
                if (guidanceScale !== undefined) document.getElementById('guidance').value = guidanceScale;
                
                if (settings.seed) document.getElementById('seed').value = settings.seed;
                if (settings.scheduler) {
                    document.getElementById('scheduler').value = settings.scheduler;
                    document.querySelectorAll('.scheduler-option').forEach(btn => {
                        if (btn.dataset.value === settings.scheduler) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                }
            }
        });
        
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            if (newTheme === 'dark') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
            }
        }
        
        // Initialize theme
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const icon = document.getElementById('theme-icon');
            if (savedTheme === 'dark' && icon) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
            }
        })();
    </script>
</body>
</html>